const records = [];
async function getRecords() {
	const token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
	const response = await fetch(`${BASE_URL}/search`, {
		headers: {
			"X-CSRF-Token": token
		},
		method: 'POST',
	});
	const data = await response.json();
	const result = await data;
	[...result].forEach((item) => {
		records.push({
			'surname': item.person_surname,
			'name': item.person_name,
			'patronymic': item.person_patronymic
		})
	})
}
getRecords();
// –í —Ñ—É–Ω–∫—Ü–∏–∏ contains –º—ã –±—É–¥–µ–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å,
// —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å
// –≤ –∫–∞–∫–æ–º-–ª–∏–±–æ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏–π:
function contains(query) {
	return records.filter((obj) =>
		obj.surname.toLowerCase().includes(query.toLowerCase())
	)
}
// –ú–æ–∫-–æ–±—ä–µ–∫—Ç —Å–µ—Ä–≤–µ—Ä–∞ –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–µ—Ç–æ–¥ search:
const server = {
	search(query) {
		// –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –±—É–¥–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –ø—Ä–æ–º–∏—Å,
		// —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º –º—ã –±—É–¥–µ–º —ç–º—É–ª–∏—Ä–æ–≤–∞—Ç—å ¬´–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å¬ª,
		// –∫–∞–∫ –±—É–¥—Ç–æ –º—ã ¬´—Å—Ö–æ–¥–∏–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä, –æ–Ω –ø–æ–¥—É–º–∞–ª –∏ –æ—Ç–≤–µ—Ç–∏–ª¬ª.

		// –ü–æ—Å—Ç–∞–≤–∏–º –ª–æ–≥–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –≤—ã–≤–æ–¥–∏—Ç—å
		// –∫–∞–∂–¥—ã–π –ø—Ä–∏–Ω—è—Ç—ã–π –∑–∞–ø—Ä–æ—Å:
		console.log(query)
		return new Promise((resolve) => {
			// –¢–∞–π–º–∞—É—Ç –Ω—É–∂–µ–Ω –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è —Ç–æ–≥–æ,
			// —á—Ç–æ–±—ã –∏–º–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –≤—Ä–µ–º—è –∑–∞–¥–µ—Ä–∂–∫–∏ üôÇ
			setTimeout(
				() =>
					resolve({
						// –í –∫–∞—á–µ—Å—Ç–≤–µ –æ—Ç–≤–µ—Ç–∞ –±—É–¥–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ–±—ä–µ–∫—Ç,
						// –∑–Ω–∞—á–µ–Ω–∏–µ–º –ø–æ–ª—è list –∫–æ—Ç–æ—Ä–æ–≥–æ
						// –±—É–¥–µ—Ç –Ω–∞—à –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤.
						list: query ? contains(query) : [],
					}),
				150
			)
		})
	},
}

const searchInput = document.querySelector('input[name="custom_search"]');
const searchResults = document.querySelector('.search-results');

function handleInput(e) {
	const { value } = e.target
	// –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –ø–æ–ª–µ,
	// –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º —Å—Ä–∞–±–æ—Ç–∞–ª–æ —Å–æ–±—ã—Ç–∏–µ:
	server.search(value).then(function (response) {
		const { list } = response
		const html = list.reduce((markup, item) => {
			return `${markup}<li>${item}</li>`
		}, ``)

		searchResults.innerHTML = html
	})
}

// –ê—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –±—É–¥—É—Ç:
// - —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä—É—é –Ω–∞–¥–æ ¬´–æ—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å¬ª;
// - –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤—Ä–µ–º–µ–Ω–∏, —Å–ø—É—Å—Ç—è –∫–æ—Ç–æ—Ä–æ–µ —Ñ—É–Ω–∫—Ü–∏—é —Å–ª–µ–¥—É–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å.
function debounce(callee, timeoutMs) {
	// –ö–∞–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –¥—Ä—É–≥—É—é —Ñ—É–Ω–∫—Ü–∏—é.
	// –≠—Ç–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –º—ã –º–æ–≥–ª–∏ –Ω–µ –º–µ–Ω—è—Ç—å –¥—Ä—É–≥–∏–µ —á–∞—Å—Ç–∏ –∫–æ–¥–∞,
	// —á—É—Ç—å –ø–æ–∑–∂–µ –º—ã —É–≤–∏–¥–∏–º, –∫–∞–∫ —ç—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç.
	return function perform(...args) {
		// –í –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π previousCall –º—ã –±—É–¥–µ–º —Ö—Ä–∞–Ω–∏—Ç—å
		// –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –≤—ã–∑–æ–≤–∞...
		let previousCall = this.lastCall
		// ...–∞ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π —Ç–µ–∫—É—â–µ–≥–æ –≤—ã–∑–æ–≤–∞ ‚Äî
		// –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É –Ω—ã–Ω–µ—à–Ω–µ–≥–æ –º–æ–º–µ–Ω—Ç–∞.
		this.lastCall = Date.now()
		// –ù–∞–º —ç—Ç–æ –±—É–¥–µ—Ç –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º —Å—Ä–∞–≤–Ω–∏—Ç—å,
		// –∫–æ–≥–¥–∞ –±—ã–ª–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑–≤–∞–Ω–∞ –≤ —ç—Ç–æ—Ç —Ä–∞–∑ –∏ –≤ –ø—Ä–µ–¥—ã–¥—É—â–∏–π.
		// –ï—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É –≤—ã–∑–æ–≤–∞–º–∏ –º–µ–Ω—å—à–µ, —á–µ–º —É–∫–∞–∑–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª,
		// —Ç–æ –º—ã –æ—á–∏—â–∞–µ–º —Ç–∞–π–º–∞—É—Ç...
		if (previousCall && this.lastCall - previousCall <= timeoutMs) {
			clearTimeout(this.lastCallTimer)
		}
		// ...–∫–æ—Ç–æ—Ä—ã–π –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏-–∞—Ä–≥—É–º–µ–Ω—Ç–∞.
		// –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ, —á—Ç–æ –º—ã –ø–µ—Ä–µ–¥–∞—ë–º –≤—Å–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã ...args,
		// –∫–æ—Ç–æ—Ä—ã–π –ø–æ–ª—É—á–∞–µ–º –≤ —Ñ—É–Ω–∫—Ü–∏–∏ perform ‚Äî
		// —ç—Ç–æ —Ç–æ–∂–µ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –Ω–∞–º –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏–ª–æ—Å—å –º–µ–Ω—è—Ç—å –¥—Ä—É–≥–∏–µ —á–∞—Å—Ç–∏ –∫–æ–¥–∞.
		this.lastCallTimer = setTimeout(() => callee(...args), timeoutMs)
		// –ï—Å–ª–∏ —Ç–∞–π–º–∞—É—Ç –±—ã–ª –æ—á–∏—â–µ–Ω, –≤—ã–∑–æ–≤–∞ –Ω–µ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç
		// –µ—Å–ª–∏ –æ–Ω –æ—á–∏—â–µ–Ω –Ω–µ –±—ã–ª, —Ç–æ callee –≤—ã–∑–æ–≤–µ—Ç—Å—è.
		// –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º –º—ã –∫–∞–∫ –±—ã ¬´–æ—Ç–æ–¥–≤–∏–≥–∞–µ–º¬ª –≤—ã–∑–æ–≤ callee
		// –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ ¬´—Å–Ω–∞—Ä—É–∂–∏ –≤—Å—ë –Ω–µ –ø–æ–¥—É—Å–ø–æ–∫–æ–∏—Ç—Å—è¬ª.
	}
}
const debouncedHandle = debounce(handleInput, 250)
if (searchInput) {
	searchInput.addEventListener('input', debouncedHandle)
}

